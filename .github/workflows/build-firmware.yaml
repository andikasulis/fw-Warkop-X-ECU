name: Create Board Firmware

on:
  schedule:
    - cron: '0 0 * * *' # build fresh every midnight (that help local compilation by having local and remote date in signature match)
  push:
  #  pull_request:
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Jakarta  # Set timezone to WIB (UTC+7)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set run variables
        id: set-variables
        run: |
          BUILD_TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          if [ "${{github.event_name}}" = "schedule" ]; then
            echo "release_date=${BUILD_TIMESTAMP}" >> $GITHUB_ENV
          fi
          if [ "${{github.event_name}}" == "push" -o "${{github.event_name}}" == "schedule" -o "${{github.event_name}}" == "workflow_dispatch" ] && [ "${{github.ref}}" == "refs/heads/master" -o "${{github.ref}}" == "refs/heads/main" ]; then
            echo 'extra_makefile_targets=build_both_bundles' >> $GITHUB_OUTPUT
            echo 'upload=ftp_upload_bundles' >> $GITHUB_OUTPUT
            echo 'push=true' >> $GITHUB_OUTPUT
            echo 'sim=true' >> $GITHUB_OUTPUT
          else
            echo 'push=false' >> $GITHUB_OUTPUT
            echo 'sim=false' >> $GITHUB_OUTPUT
          fi

      - uses: ./ext/rusefi/.github/workflows/custom-board-build
        with:
          new_tag: ${{steps.set-variables.outputs.release_date}}
          artifacts: bin srec hex list map elf bundle autoupdate
          # see above about un-commenting
          uploads: ini ${{steps.set-variables.outputs.upload}}
          push: ${{steps.set-variables.outputs.push}}
          run_simulator: ${{ steps.set-variables.outputs.sim }}
          MY_REPO_PAT: ${{secrets.MY_REPO_PAT}}
          RUSEFI_ONLINE_FTP_USER: ${{secrets.RUSEFI_ONLINE_FTP_USER}}
          RUSEFI_ONLINE_FTP_PASS: ${{secrets.RUSEFI_ONLINE_FTP_PASS}}
          RUSEFI_FTP_SERVER: ${{secrets.RUSEFI_FTP_SERVER}}
          RUSEFI_SSH_SERVER: ${{secrets.RUSEFI_SSH_SERVER}}
          RUSEFI_SSH_USER: ${{secrets.RUSEFI_SSH_USER}}
          RUSEFI_SSH_PASS: ${{secrets.RUSEFI_SSH_PASS}}
          ADDITIONAL_ENV: RUSEFI_BUILD_DATE=${{steps.set-variables.outputs.build_timestamp}}

      # Rename binary files with surgical precision
      - name: Prepare Precise Artifacts
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          
          # 1. Cari binary asli (297KB) - biasanya ada di folder build rusefi
          # Kita cari secara kumulatif tapi laporkan sizenya
          echo "=== Debug: Checking file sizes ==="
          ls -l rusefi* 2>/dev/null || true
          ls -l bin/rusefi* 2>/dev/null || true
          
          # Target file .bin (HARUS ~297KB)
          BIN_SRC=$(ls bin/rusefi.bin 2>/dev/null || ls rusefi.bin 2>/dev/null || find . -name "rusefi.bin" | head -n 1)
          if [ -n "$BIN_SRC" ]; then
            cp "$BIN_SRC" "rusefi_warkop_x_${TIMESTAMP}.bin"
            SIZE_BYTES=$(stat -c%s "$BIN_SRC")
            echo "‚úì BINARY FOUND: $BIN_SRC"
            echo "  - Size: $SIZE_BYTES bytes (Expect ~304000 for 297KB)"
            echo "  - Renamed to: rusefi_warkop_x_${TIMESTAMP}.bin"
          fi

          # Target file .hex (~474KB)
          HEX_SRC=$(ls bin/rusefi.hex 2>/dev/null || ls rusefi.hex 2>/dev/null || find . -name "rusefi.hex" | head -n 1)
          if [ -n "$HEX_SRC" ]; then
            cp "$HEX_SRC" "rusefi_warkop_x_${TIMESTAMP}.hex"
            SIZE_BYTES=$(stat -c%s "$HEX_SRC")
            echo "‚úì HEX FOUND: $HEX_SRC"
            echo "  - Size: $SIZE_BYTES bytes (Expect ~485000 for 474KB)"
            echo "  - Renamed to: rusefi_warkop_x_${TIMESTAMP}.hex"
          fi

          # Target file .ini (~138KB)
          INI_SRC=$(find . -name "rusefi_warkop_x.ini" | head -n 1)
          if [ -n "$INI_SRC" ]; then
            cp "$INI_SRC" "rusefi_warkop_x_${TIMESTAMP}.ini"
            echo "‚úì INI: $INI_SRC ($(du -h $INI_SRC | cut -f1)) -> rusefi_warkop_x_${TIMESTAMP}.ini"
          fi
        shell: bash

      # Auto-patch TunerStudio .ini with custom Idle Rumble menu
      - name: Patch .ini with Custom Idle Rumble Menu
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          INI_FILE="rusefi_warkop_x_${TIMESTAMP}.ini"
          
          if [ ! -f "$INI_FILE" ]; then
            echo "‚ö†Ô∏è INI file not found, skipping patch"
            exit 0
          fi
          
          echo "üîß Patching $INI_FILE with idle rumble custom menu..."
          
          # Check if already patched
          if grep -q "idleRumbleDialog" "$INI_FILE"; then
            echo "‚úì Already patched!"
            exit 0
          fi
          
          # Create backup
          cp "$INI_FILE" "${INI_FILE}.backup"
          
          # Add dialog definition to [UserDefined] section
          awk '
          /^\[UserDefined\]/ { 
            print;
            print ""; 
            print "   ; ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê";
            print "   ; Idle Rumble Custom Dialog - Auto-patched by GitHub Actions";
            print "";
            print "   idleRumbleMethodList = bits, U08, [0:1], \\\"Timing\\\", \\\"Fuel\\\", \\\"Spark\\\", \\\"Combined\\\"";
            print "";
            print "   ; ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê";
            print "   dialog = idleRumbleDialog, \"‚ö° Idle Rumble - Drumbal Effect\"";
            print "      panel = idleRumblePanel";
            print "      ";
            print "   panel = idleRumblePanel";
            print "      field = \"#Idle Rumble creates aggressive idle sound\"";
            print "      field = \"#Works with cable throttle (no idle valve)\"";
            print "      field = \"\"";
            print "      field = \"Enable Idle Rumble\", idleRumbleEnabled";
            print "      field = \"\"";
            print "      field = \"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Basic Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\"";
            print "      field = \"Rumble Amplitude (%)\", idleRumbleAmplitude, {idleRumbleEnabled == 1}";
            print "      field = \"Rumble Speed/Period\", idleRumblePeriod, {idleRumbleEnabled == 1}";
            print "      field = \"\"";
            print "      field = \"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Method ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\"";
            print "      field = \"Method\", idleRumbleMethod, idleRumbleMethodList, {idleRumbleEnabled == 1}";
            print "      field = \"\"";
            print "      field = \"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Advanced ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\"";
            print "      field = \"Max Timing Offset (deg)\", idleRumbleTiming, {idleRumbleEnabled == 1 && (idleRumbleMethod == 0 || idleRumbleMethod == 3)}";
            print "      field = \"Max Fuel Adjustment (%)\", idleRumbleFuel, {idleRumbleEnabled == 1 && (idleRumbleMethod == 1 || idleRumbleMethod == 3)}";
            print "      field = \"\"";
            print "      field = \"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Limits ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\"";
            print "      field = \"Max Active RPM\", idleRumbleMaxRpm, {idleRumbleEnabled == 1}";
            print "      field = \"Max Active TPS (%)\", idleRumbleMaxTps, {idleRumbleEnabled == 1}";
            print "";
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          # Add menu item to [Menu] section
          awk '
          BEGIN { menu_added=0 }
          /menuDialog = main/ { in_menu=1; print; next }
          in_menu && /^   / && !menu_added {
            print "      ; Custom Idle Rumble Menu (auto-patched)"
            print "      subMenu = idleRumbleDialog, \"‚ö° Idle Rumble\""
            menu_added=1
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          echo "‚úÖ Patch applied successfully!"
          echo "üìù .ini file now includes custom '‚ö° Idle Rumble' menu"
        shell: bash

      # Upload Individual Artifacts with Very Clear Names
      - name: Upload BINARY (.bin)
        uses: actions/upload-artifact@v4
        with:
          name: Firmware_BINARY_297KB_${{steps.set-variables.outputs.build_timestamp}}
          path: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.bin

      - name: Upload HEX (.hex)
        uses: actions/upload-artifact@v4
        with:
          name: Firmware_HEX_474KB_${{steps.set-variables.outputs.build_timestamp}}
          path: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.hex

      - name: Upload TunerStudio INI
        uses: actions/upload-artifact@v4
        with:
          name: TunerStudio_INI_${{steps.set-variables.outputs.build_timestamp}}
          path: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.ini
