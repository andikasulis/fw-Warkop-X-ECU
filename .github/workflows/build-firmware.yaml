name: Build Firmware

on:
  push:
    branches:
      - dev-feat-rumble
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0
      
      - name: Set build variables
        id: set-variables
        run: |
          BUILD_TIMESTAMP=$(TZ='Asia/Jakarta' date +'%Y-%m-%d_%H-%M')
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "üìÖ Build Timestamp: $BUILD_TIMESTAMP"
        shell: bash
      
      - name: Build Warkop-X Firmware
        uses: ./.github/actions/build-board
        with:
          board-name: warkop_x
          efi-variant: EFI_PROD_CODE=1 USE_OPENBLT=yes
          meta-info: R1-VET6
      
      - name: Check and list compiled firmware
        run: |
          echo "Testing compiled firmware..."
          COMPILED_LIST=$(ls -lh ext/rusefi/firmware/build/rusefi*.bin 2>/dev/null || echo "")
          
          if [ -z "$COMPILED_LIST" ]; then
            echo "ERROR: No firmware binaries found!"
            exit 1
          fi
          
          echo "Found firmware files:"
          echo "$COMPILED_LIST"
        shell: bash
      
      - name: Prepare firmware artifacts with timestamp in filename
        run: |
          BUILD_TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          
          mkdir -p firmware-artifacts
          
          # Copy firmware binary with timestamp
          echo "Copying firmware artifacts..."
          cp ext/rusefi/firmware/build/rusefi.bin firmware-artifacts/rusefi_warkop_x_${BUILD_TIMESTAMP}.bin
          
          # Create README for easier identification
          echo "Warkop-X ECU Firmware Build" > firmware-artifacts/README.txt
          echo "===========================" >> firmware-artifacts/README.txt
          echo "Board: Warkop-X (STM32F407VET6 - 512KB Flash)" >> firmware-artifacts/README.txt
          echo "Build Date: ${BUILD_TIMESTAMP}" >> firmware-artifacts/README.txt
          echo "Commit: ${GITHUB_SHA:0:8}" >> firmware-artifacts/README.txt
          echo "Branch: ${GITHUB_REF_NAME}" >> firmware-artifacts/README.txt
          echo "" >> firmware-artifacts/README.txt
          echo "Files:" >> firmware-artifacts/README.txt
          echo "------" >> firmware-artifacts/README.txt
          echo "- rusefi_warkop_x_${BUILD_TIMESTAMP}.bin : Main firmware binary" >> firmware-artifacts/README.txt
          echo "- rusefi_warkop_x_${BUILD_TIMESTAMP}.ini : TunerStudio config" >> firmware-artifacts/README.txt
          echo "" >> firmware-artifacts/README.txt
          echo "How to use:" >> firmware-artifacts/README.txt
          echo "-----------" >> firmware-artifacts/README.txt
          echo "1. Flash the .bin file to your Warkop-X ECU" >> firmware-artifacts/README.txt
          echo "2. Load the .ini file in TunerStudio" >> firmware-artifacts/README.txt
          echo "3. Connect and tune!" >> firmware-artifacts/README.txt
          
          echo "Artifacts prepared successfully"
          ls -lh firmware-artifacts/
        shell: bash
      
      - name: Verify .ini file exists
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          INI_FILE="rusefi_warkop_x_${TIMESTAMP}.ini"
          
          if [ ! -f "$INI_FILE" ]; then
            echo "ERROR: .ini file not generated!"
            echo "Looking for files matching pattern:"
            ls -lh *warkop*.ini || true
            exit 1
          fi
        shell: bash

      # Auto-patch TunerStudio .ini with custom Idle Rumble menu
      - name: Patch .ini with Custom Idle Rumble Menu
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          INI_FILE="rusefi_warkop_x_${TIMESTAMP}.ini"
          
          if [ ! -f "$INI_FILE" ]; then
            echo "‚ö†Ô∏è INI file not found, skipping patch"
            exit 0
          fi
          
          echo "üîß Patching $INI_FILE with idle rumble custom menu..."
          
          # Check if already patched
          if grep -q "idleRumbleDialog" "$INI_FILE"; then
            echo "‚úì Already patched!"
            exit 0
          fi
          
          # Create backup
          cp "$INI_FILE" "${INI_FILE}.backup"
          
          # Add dialog definition to [UserDefined] section
          awk '
          /^\[UserDefined\]/ { 
            print;
            print ""; 
            print "   ; ===================================================================";
            print "   ; Idle Rumble Custom Dialog - Auto-patched by GitHub Actions";
            print "   ; ===================================================================";
            print "";
            print "   dialog = idleRumbleDialog, \"Idle Rumble Settings\"";
            print "      panel = idleRumblePanel";
            print "      ";
            print "   panel = idleRumblePanel";
            print "      field = \"#Idle Rumble creates aggressive idle sound\"";
            print "      field = \"#Works with cable throttle (no idle valve)\"";
            print "      field = \"\"";
            print "      field = \"Enable Idle Rumble\", idleRumbleEnabled";
            print "      field = \"\"";
            print "      field = \"===== Basic Settings =====\"";
            print "      field = \"Rumble Amplitude (%)\", idleRumbleAmplitude, {idleRumbleEnabled == 1}";
            print "      field = \"Rumble Speed/Period\", idleRumblePeriod, {idleRumbleEnabled == 1}";
            print "      field = \"\"";
            print "      field = \"===== Method =====\"";
            print "      field = \"#0=Timing, 1=Fuel, 2=Spark, 3=Combined\"";
            print "      field = \"Method\", idleRumbleMethod, {idleRumbleEnabled == 1}";
            print "      field = \"\"";
            print "      field = \"===== Advanced =====\"";
            print "      field = \"Max Timing Offset (deg)\", idleRumbleTiming, {idleRumbleEnabled == 1 && (idleRumbleMethod == 0 || idleRumbleMethod == 3)}";
            print "      field = \"Max Fuel Adjustment (%)\", idleRumbleFuel, {idleRumbleEnabled == 1 && (idleRumbleMethod == 1 || idleRumbleMethod == 3)}";
            print "      field = \"\"";
            print "      field = \"===== Limits =====\"";
            print "      field = \"Max Active RPM\", idleRumbleMaxRpm, {idleRumbleEnabled == 1}";
            print "      field = \"Max Active TPS (%)\", idleRumbleMaxTps, {idleRumbleEnabled == 1}";
            print "";
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          # Add menu item to [Menu] section
          awk '
          BEGIN { menu_added=0 }
          /menuDialog = main/ { in_menu=1; print; next }
          in_menu && /^   / && !menu_added {
            print "      ; Custom Idle Rumble Menu (auto-patched)"
            print "      subMenu = idleRumbleDialog, \"Idle Rumble\""
            menu_added=1
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          echo "‚úÖ Patch applied successfully!"
          echo "üìù .ini file now includes custom 'Idle Rumble' menu"
        shell: bash

      # Upload Individual Artifacts with Very Clear Names
      - name: Upload BINARY (.bin)
        uses: actions/upload-artifact@v4
        with:
          name: firmware-warkop-x-BINARY
          path: firmware-artifacts/*.bin
          retention-days: 30
          
      - name: Upload INI (TunerStudio config)
        uses: actions/upload-artifact@v4
        with:
          name: firmware-warkop-x-INI
          path: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.ini
          retention-days: 30
          
      - name: Upload README
        uses: actions/upload-artifact@v4
        with:
          name: firmware-warkop-x-README
          path: firmware-artifacts/README.txt
          retention-days: 30
