name: Create Board Firmware

on:
  schedule:
    - cron: '0 0 * * *' # build fresh every midnight (that help local compilation by having local and remote date in signature match)
  push:
  #  pull_request:
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Jakarta  # Set timezone to WIB (UTC+7)
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set run variables
        id: set-variables
        run: |
          BUILD_TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          if [ "${{github.event_name}}" = "schedule" ]; then
            echo "release_date=${BUILD_TIMESTAMP}" >> $GITHUB_ENV
          fi
          if [ "${{github.event_name}}" == "push" -o "${{github.event_name}}" == "schedule" -o "${{github.event_name}}" == "workflow_dispatch" ] && [ "${{github.ref}}" == "refs/heads/master" -o "${{github.ref}}" == "refs/heads/main" ]; then
            echo 'extra_makefile_targets=build_both_bundles' >> $GITHUB_OUTPUT
            echo 'upload=ftp_upload_bundles' >> $GITHUB_OUTPUT
            echo 'push=true' >> $GITHUB_OUTPUT
            echo 'sim=true' >> $GITHUB_OUTPUT
          else
            echo 'push=false' >> $GITHUB_OUTPUT
            echo 'sim=false' >> $GITHUB_OUTPUT
          fi

      - uses: ./ext/rusefi/.github/workflows/custom-board-build
        with:
          new_tag: ${{steps.set-variables.outputs.release_date}}
          artifacts: bin srec hex list map elf bundle autoupdate
          # see above about un-commenting
          uploads: ini ${{steps.set-variables.outputs.upload}}
          push: ${{steps.set-variables.outputs.push}}
          run_simulator: ${{ steps.set-variables.outputs.sim }}
          MY_REPO_PAT: ${{secrets.MY_REPO_PAT}}
          RUSEFI_ONLINE_FTP_USER: ${{secrets.RUSEFI_ONLINE_FTP_USER}}
          RUSEFI_ONLINE_FTP_PASS: ${{secrets.RUSEFI_ONLINE_FTP_PASS}}
          RUSEFI_FTP_SERVER: ${{secrets.RUSEFI_FTP_SERVER}}
          RUSEFI_SSH_SERVER: ${{secrets.RUSEFI_SSH_SERVER}}
          RUSEFI_SSH_USER: ${{secrets.RUSEFI_SSH_USER}}
          RUSEFI_SSH_PASS: ${{secrets.RUSEFI_SSH_PASS}}
          ADDITIONAL_ENV: RUSEFI_BUILD_DATE=${{steps.set-variables.outputs.build_timestamp}}

      # Rename binary files with timestamp for version tracking
      - name: Rename binaries and INI with build timestamp
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          
          # Handle main firmware artifacts specifically from the bin folder
          # These are the definitive outputs
          if [ -d "bin" ]; then
            cd bin/
            for file in rusefi.*; do
              if [ -f "$file" ]; then
                ext="${file##*.}"
                cp "$file" "rusefi_warkop_x_${TIMESTAMP}.${ext}"
                echo "✓ Copied for upload from bin/: $file -> rusefi_warkop_x_${TIMESTAMP}.${ext}"
              fi
            done
            cd ..
          fi
          
          # Also handle the INI file specifically
          INI_FILE="generated/tunerstudio/generated/rusefi_warkop_x.ini"
          if [ -f "$INI_FILE" ]; then
            cp "$INI_FILE" "generated/tunerstudio/generated/rusefi_warkop_x_${TIMESTAMP}.ini"
            echo "✓ Copied for upload: $INI_FILE -> rusefi_warkop_x_${TIMESTAMP}.ini"
          fi
        shell: bash
        continue-on-error: true

      # Upload Renamed Binaries as separate individual artifacts
      - name: Upload Renamed .bin
        uses: actions/upload-artifact@v4
        with:
          name: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.bin
          path: "bin/rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.bin"
          if-no-files-found: warn

      - name: Upload Renamed .hex
        uses: actions/upload-artifact@v4
        with:
          name: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.hex
          path: "bin/rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.hex"
          if-no-files-found: warn

      - name: Upload Renamed .srec
        uses: actions/upload-artifact@v4
        with:
          name: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.srec
          path: "bin/rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.srec"
          if-no-files-found: warn

      # Upload INI file as separate artifact with clear .ini extension in name
      - name: Upload INI artifact
        uses: actions/upload-artifact@v4
        with:
          name: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.ini
          path: generated/tunerstudio/generated/rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.ini
          if-no-files-found: warn
