name: Build Firmware

on:
  push:
    branches:
      - dev-feat-rumble
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0
      
      - name: Set build variables
        id: set-variables
        run: |
          BUILD_TIMESTAMP=$(TZ='Asia/Jakarta' date +'%Y-%m-%d_%H-%M')
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "üìÖ Build Timestamp: $BUILD_TIMESTAMP"
        shell: bash
      
      # Use rusEFI's official custom board build action
      - name: Build Warkop-X Firmware
        uses: ./ext/rusefi/.github/workflows/custom-board-build
        with:
          artifacts: bin hex ini
          uploads: ''
          push: 'false'
          run_simulator: 'false'
      
      # Prepare artifacts with timestamp
      - name: Prepare firmware artifacts with timestamp
        run: |
          BUILD_TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          
          mkdir -p firmware-artifacts
          
          # Copy firmware binary
          if [ -f ext/rusefi/firmware/deliver/rusefi.bin ]; then
            cp ext/rusefi/firmware/deliver/rusefi.bin firmware-artifacts/rusefi_warkop_x_${BUILD_TIMESTAMP}.bin
            echo "‚úÖ Binary copied"
          fi
          
          # Find and copy .ini file
          INI_FILE=$(find generated/tunerstudio/generated -name "*.ini" 2>/dev/null | head -n 1)
          if [ -n "$INI_FILE" ]; then
            cp "$INI_FILE" rusefi_warkop_x_${BUILD_TIMESTAMP}.ini
            echo "‚úÖ INI copied: $INI_FILE"
          fi
          
          ls -lh firmware-artifacts/
        shell: bash

      # Auto-patch TunerStudio .ini with custom Idle Rumble menu
      - name: Patch .ini with Custom Idle Rumble Menu
        run: |
          TIMESTAMP="${{steps.set-variables.outputs.build_timestamp}}"
          INI_FILE="rusefi_warkop_x_${TIMESTAMP}.ini"
          
          if [ ! -f "$INI_FILE" ]; then
            echo "‚ö†Ô∏è INI file not found, skipping patch"
            exit 0
          fi
          
          echo "üîß Patching $INI_FILE with idle rumble custom menu..."
          
          # Check if already patched
          if grep -q "idleRumbleDialog" "$INI_FILE"; then
            echo "‚úì Already patched!"
            exit 0
          fi
          
          # Create backup
          cp "$INI_FILE" "${INI_FILE}.backup"
          
          # Add dialog definition to [UserDefined] section
          awk '
          /^\[UserDefined\]/ { 
            in_section=1;
            print;
            next;
          }
          in_section && /^$/ && !dialog_added {
            print "";
            print "   ; ===================================================================";
            print "   ; Idle Rumble Custom Dialog - Auto-patched by GitHub Actions";
            print "   ; ===================================================================";
            print "";
            print "   dialog = idleRumbleDialog, \"Idle Rumble Settings\"";
            print "      panel = idleRumblePanel";
            print "";
            print "   panel = idleRumblePanel";
            print "      field = \"#Idle Rumble creates aggressive idle sound\"";
            print "      field = \"#Works with cable throttle (no idle valve)\"";
            print "      field = \"\"";
            print "      field = \"Enable Idle Rumble\", idleRumbleEnabled";
            print "      field = \"\"";
            print "      field = \"===== Basic Settings =====\"";
            print "      field = \"Rumble Amplitude (%)\", idleRumbleAmplitude";
            print "      field = \"Rumble Speed/Period\", idleRumblePeriod";
            print "      field = \"\"";
            print "      field = \"===== Method =====\"";
            print "      field = \"#0=Timing, 1=Fuel, 2=Spark, 3=Combined\"";
            print "      field = \"Method\", idleRumbleMethod";
            print "      field = \"\"";
            print "      field = \"===== Advanced =====\"";
            print "      field = \"Max Timing Offset (deg)\", idleRumbleTiming";
            print "      field = \"Max Fuel Adjustment (%)\", idleRumbleFuel";
            print "      field = \"\"";
            print "      field = \"===== Limits =====\"";
            print "      field = \"Max Active RPM\", idleRumbleMaxRpm";
            print "      field = \"Max Active TPS (%)\", idleRumbleMaxTps";
            print "";
            dialog_added=1;
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          # Add menu item to [Menu] section
          awk '
          BEGIN { menu_added=0 }
          /menuDialog = main/ { in_menu=1; print; next }
          in_menu && /^   / && !menu_added {
            print "      ; Custom Idle Rumble Menu (auto-patched)"
            print "      subMenu = idleRumbleDialog, \"Idle Rumble\""
            menu_added=1
          }
          { print }
          ' "$INI_FILE" > "${INI_FILE}.tmp"
          mv "${INI_FILE}.tmp" "$INI_FILE"
          
          echo "‚úÖ Patch applied successfully!"
          echo "üìù .ini file now includes custom 'Idle Rumble' menu"
        shell: bash

      # Upload artifacts
      - name: Upload Firmware Binary
        uses: actions/upload-artifact@v4
        with:
          name: firmware-warkop-x-BINARY
          path: firmware-artifacts/*.bin
          retention-days: 30
          
      - name: Upload TunerStudio INI
        uses: actions/upload-artifact@v4
        with:
          name: firmware-warkop-x-INI
          path: rusefi_warkop_x_${{steps.set-variables.outputs.build_timestamp}}.ini
          retention-days: 30
